<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	    <title>MEBOCOST mCCC Explorer · Demo Landing</title>
	    <style>
	      :root {
	        --bg: #fafaf9;
	        --card: #ffffff;
	        --text: #111827;
	        --muted: #6b7280;
	        --border: rgba(17, 24, 39, 0.12);
	        --border-strong: rgba(17, 24, 39, 0.18);
	        --shadow-soft: 0 0 0 1px rgba(15, 23, 42, 0.06), 0 1px 1px rgba(17, 24, 39, 0.03), 0 10px 22px rgba(17, 24, 39, 0.04);
	        --primary: #2563eb;
	        --primary-strong: #1d4ed8;
	        --ring: rgba(37, 99, 235, 0.20);
	        --success: #16a34a;
	        --violet: #7c3aed;
	      }

	      * {
	        margin: 0;
	        padding: 0;
	        box-sizing: border-box;
	      }

	      body {
	        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
	        background: var(--bg);
	        color: var(--text);
	        line-height: 1.35;
	        overflow: hidden;
	        height: 100vh;
	        width: 100vw;
	      }

      a {
        color: inherit;
        text-decoration: none;
      }

	      .bg-pattern {
	        position: fixed;
	        top: 0;
	        left: 0;
	        width: 100%;
	        height: 100%;
	        opacity: 0.55;
	        background-image: linear-gradient(rgba(37, 99, 235, 0.08) 1px, transparent 1px),
	          linear-gradient(90deg, rgba(37, 99, 235, 0.08) 1px, transparent 1px);
	        background-size: 64px 64px;
	        animation: gridMove 26s linear infinite;
	        pointer-events: none;
	        z-index: 0;
	      }

      @keyframes gridMove {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(50px);
        }
      }

	      .glow-orb {
	        position: fixed;
	        width: 800px;
	        height: 800px;
	        background: radial-gradient(circle, rgba(37, 99, 235, 0.20) 0%, transparent 70%);
	        border-radius: 50%;
	        pointer-events: none;
	        animation: float 18s ease-in-out infinite;
	        z-index: 0;
	        filter: blur(80px);
	      }

      .glow-orb-1 {
        top: -300px;
        left: -300px;
      }

	      .glow-orb-2 {
	        bottom: -300px;
	        right: -300px;
	        background: radial-gradient(circle, rgba(124, 58, 237, 0.16) 0%, transparent 70%);
	        animation-delay: 9s;
	      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        33% {
          transform: translate(100px, 50px) scale(1.15);
        }
        66% {
          transform: translate(-50px, 100px) scale(0.9);
        }
      }

	      .command-deck {
	        position: fixed;
	        top: 0;
	        left: 0;
	        right: 0;
	        height: 70px;
	        z-index: 100;
	        background: rgba(250, 250, 249, 0.86);
	        backdrop-filter: blur(14px);
	        border-bottom: 1px solid var(--border);
	        box-shadow: 0 12px 30px rgba(17, 24, 39, 0.06);
	        display: flex;
	        align-items: center;
	        gap: 1.25rem;
	        padding: 0 2rem;
	        transition: all 0.4s ease-out;
	      }

	      .command-deck.processing {
	        box-shadow: 0 16px 44px rgba(37, 99, 235, 0.12), 0 0 0 1px rgba(37, 99, 235, 0.06);
	        border-bottom-color: rgba(37, 99, 235, 0.22);
	      }

	      .logo {
	        font-size: 0.8125rem;
	        font-weight: 800;
	        letter-spacing: -0.02em;
	        text-transform: none;
	        white-space: nowrap;
	        flex-shrink: 0;
	      }

	      .logo::before {
	        content: "";
	        display: inline-block;
	        width: 10px;
	        height: 10px;
	        margin-right: 10px;
	        border-radius: 999px;
	        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.92), rgba(37, 99, 235, 0.85) 55%, rgba(29, 78, 216, 0.98));
	        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.10), 0 10px 20px rgba(37, 99, 235, 0.18);
	      }

	      .command-input-box {
	        flex: 1;
	        background: rgba(255, 255, 255, 0.92);
	        border: 1px solid var(--border);
	        border-radius: 1rem;
	        padding: 0.75rem 1.25rem;
	        font-size: 0.9375rem;
	        color: rgba(17, 24, 39, 0.92);
	        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
	        min-height: 1.5em;
	        box-shadow: var(--shadow-soft);
	        transition: all 0.4s ease-out;
	        white-space: nowrap;
	        overflow: hidden;
	        text-overflow: ellipsis;
	      }

	      .cursor-blink {
	        display: inline-block;
	        width: 2px;
	        height: 1.2em;
	        background: var(--primary);
	        margin-left: 3px;
	        animation: blink 1.1s step-end infinite;
	        vertical-align: text-bottom;
	        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.10);
	      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

	      .status-indicator {
	        display: flex;
	        align-items: center;
	        gap: 0.5rem;
	        font-size: 0.6875rem;
	        color: var(--muted);
	        text-transform: uppercase;
	        letter-spacing: 0.12em;
	        white-space: nowrap;
	      }

	      .status-dot {
	        width: 8px;
	        height: 8px;
	        background: var(--success);
	        border-radius: 50%;
	        box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.10), 0 12px 18px rgba(22, 163, 74, 0.10);
	        animation: pulseGlow 2.5s ease-in-out infinite;
	      }

	      .status-dot.busy {
	        background: var(--primary);
	        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.10), 0 12px 18px rgba(37, 99, 235, 0.14);
	      }

      @keyframes pulseGlow {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.55;
          transform: scale(0.85);
        }
      }

	      .progress {
	        position: fixed;
	        top: 70px;
	        left: 0;
	        right: 0;
	        height: 2px;
	        z-index: 101;
	        background: rgba(17, 24, 39, 0.06);
	        overflow: hidden;
	        opacity: 0;
	        transition: opacity 0.25s ease;
	      }

      .progress.active {
        opacity: 1;
      }

	      .progress-bar {
	        height: 100%;
	        width: 0%;
	        background: linear-gradient(90deg, rgba(37, 99, 235, 0.25), rgba(37, 99, 235, 0.85), rgba(124, 58, 237, 0.55));
	        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.08);
	        transition: width 0.25s ease;
	      }

      .landing-strip-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0);
        backdrop-filter: blur(0px);
        z-index: 90;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        transition: all 0.6s ease-out;
      }

	      .landing-strip-overlay.active {
	        background: rgba(250, 250, 249, 0.86);
	        backdrop-filter: blur(14px);
	        pointer-events: all;
	        overflow: hidden;
	        padding: 92px 0 22px;
	        align-items: center;
	      }

      .stage {
        width: min(1200px, 92vw);
        display: grid;
        height: calc(100vh - 92px - 22px);
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-rows: repeat(2, minmax(0, 1fr));
        gap: 18px;
        align-items: stretch;
      }

	      .evidence-card {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
	        background: rgba(255, 255, 255, 0.96);
	        backdrop-filter: blur(16px);
	        border: 1px solid var(--border);
	        border-radius: 1.5rem;
	        padding: 1.6rem 1.7rem;
	        box-shadow: var(--shadow-soft);
	        opacity: 0;
	        transform: translateY(14px) scale(0.985);
	        pointer-events: none;
	        will-change: transform, opacity;
	        transition: opacity 0.35s ease, transform 0.45s cubic-bezier(0.2, 0.8, 0.2, 1);
	      }

      .evidence-card.show {
        opacity: 1;
        transform: translateY(0px) scale(1);
        pointer-events: auto;
      }

      .card-body {
        margin-top: 0.75rem;
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        overflow: hidden;
      }

      .scroll {
        overflow: auto;
        min-height: 0;
        overscroll-behavior: contain;
        scrollbar-gutter: stable;
      }

      .agent-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.55rem;
      }

      .agent-name {
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        font-weight: 900;
        letter-spacing: 0.02em;
      }

	      .agent-pill {
	        font-size: 0.68rem;
	        letter-spacing: 0.12em;
	        text-transform: uppercase;
	        padding: 0.2rem 0.55rem;
	        border-radius: 999px;
	        border: 1px solid rgba(17, 24, 39, 0.12);
	        color: rgba(17, 24, 39, 0.72);
	        background: rgba(17, 24, 39, 0.04);
	        white-space: nowrap;
	      }

	      .agent-pill.done {
	        border-color: rgba(22, 163, 74, 0.22);
	        background: rgba(22, 163, 74, 0.08);
	        color: rgba(20, 83, 45, 0.92);
	      }

	      .agent-pill.run {
	        border-color: rgba(37, 99, 235, 0.26);
	        background: rgba(37, 99, 235, 0.10);
	        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.08);
	        color: rgba(29, 78, 216, 0.96);
	      }

	      .agent-progress {
	        margin-top: 0.65rem;
	        height: 8px;
	        border-radius: 999px;
	        background: rgba(17, 24, 39, 0.06);
	        border: 1px solid rgba(17, 24, 39, 0.06);
	        overflow: hidden;
	      }

	      .agent-progress-bar {
	        height: 100%;
	        width: 0%;
	        border-radius: 999px;
	        background: linear-gradient(90deg, rgba(37, 99, 235, 0.22), rgba(37, 99, 235, 0.72), rgba(124, 58, 237, 0.48));
	        transition: width 0.35s ease;
	        position: relative;
	        overflow: hidden;
	      }

	      .agent-progress-bar.run {
	        width: 72%;
	        background-size: 200% 100%;
	        animation: shimmer 1.2s linear infinite;
	      }

	      .agent-progress-bar.run::after {
	        content: "";
	        position: absolute;
	        top: 0;
	        bottom: 0;
	        width: 42%;
	        left: -48%;
	        background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0));
	        animation: sweep 1.15s ease-in-out infinite;
	        opacity: 0.9;
	      }

	      .agent-progress-bar.done {
	        width: 100%;
	        background: linear-gradient(90deg, rgba(22, 163, 74, 0.22), rgba(22, 163, 74, 0.82));
	        animation: none;
	      }

	      @keyframes shimmer {
	        0% {
	          background-position: 0% 0%;
	        }
	        100% {
	          background-position: 200% 0%;
	        }
	      }

	      @keyframes sweep {
	        0% {
	          transform: translateX(0);
	        }
	        100% {
	          transform: translateX(260%);
	        }
	      }

	      .agent-mono {
	        margin-top: 0;
	        padding: 0.85rem 0.95rem;
	        border-radius: 1rem;
	        border: 1px solid var(--border);
	        background: rgba(248, 250, 252, 0.92);
	        font-family: "SF Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
	        font-size: 0.86rem;
	        color: rgba(15, 23, 42, 0.86);
	        white-space: pre-wrap;
	        line-height: 1.55;
	        overflow: auto;
	        min-height: 0;
	        flex: 1;
	        scrollbar-gutter: stable;
	        overscroll-behavior: contain;
	      }

	      .evidence-card.card-2 {
	        border-color: rgba(22, 163, 74, 0.26);
	        box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.08), 0 10px 22px rgba(17, 24, 39, 0.04);
	      }

	      .evidence-card.card-4 {
	        border-color: rgba(124, 58, 237, 0.22);
	        box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.08), 0 10px 22px rgba(17, 24, 39, 0.04);
	      }

      .evidence-card.card-1.show {
        animation: land1 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) both;
      }

      .evidence-card.card-2.show {
        animation: land2 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) both;
      }

      .evidence-card.card-3.show {
        animation: land3 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) both;
      }

      @keyframes land1 {
        0% {
          transform: translateY(-22px) scale(0.965) rotateX(12deg);
          opacity: 0;
        }
        70% {
          transform: translateY(4px) scale(1.01) rotateX(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(0px) scale(1) rotateX(0deg);
          opacity: 1;
        }
      }

      @keyframes land2 {
        0% {
          transform: translateX(-22px) scale(0.97) rotate(-3deg);
          opacity: 0;
        }
        70% {
          transform: translateX(4px) scale(1.01) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateX(0px) scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      @keyframes land3 {
        0% {
          transform: translateX(22px) scale(0.97) rotate(3deg);
          opacity: 0;
        }
        70% {
          transform: translateX(-4px) scale(1.01) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateX(0px) scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      .evidence-card.card-4.show {
        animation: land4 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) both;
      }

      @keyframes land4 {
        0% {
          transform: translateY(22px) scale(0.97);
          opacity: 0;
        }
        70% {
          transform: translateY(-4px) scale(1.01);
          opacity: 1;
        }
        100% {
          transform: translateY(0px) scale(1);
          opacity: 1;
        }
      }

      @media (max-width: 1024px) {
        .landing-strip-overlay.active {
          padding: 86px 0 18px;
        }
        .stage {
          width: min(1200px, 96vw);
          gap: 12px;
          height: calc(100vh - 86px - 18px);
        }
        .evidence-card {
          padding: 1.15rem 1.2rem;
        }
        .agent-mono {
          font-size: 0.82rem;
        }
      }

      .card-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }

      .card-title h2 {
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }

	      .badge {
	        font-size: 0.7rem;
	        letter-spacing: 0.12em;
	        text-transform: uppercase;
	        padding: 0.2rem 0.55rem;
	        border-radius: 999px;
	        border: 1px solid rgba(37, 99, 235, 0.22);
	        color: rgba(29, 78, 216, 0.96);
	        background: rgba(37, 99, 235, 0.08);
	      }

	      .badge.green {
	        border-color: rgba(22, 163, 74, 0.22);
	        background: rgba(22, 163, 74, 0.08);
	        color: rgba(20, 83, 45, 0.92);
	      }

	      .muted {
	        color: var(--muted);
	      }

      .kv {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.55rem 1rem;
        margin-top: 0.85rem;
        font-size: 0.92rem;
      }

	      .kv .item {
	        display: flex;
	        justify-content: space-between;
	        gap: 0.75rem;
	        padding: 0.55rem 0.75rem;
	        border: 1px solid var(--border);
	        border-radius: 0.85rem;
	        background: rgba(248, 250, 252, 0.92);
	      }

	      .kv .k {
	        color: rgba(15, 23, 42, 0.62);
	        white-space: nowrap;
	      }

      .kv .v {
        font-weight: 800;
        letter-spacing: 0.01em;
        white-space: nowrap;
      }

      .list {
        margin-top: 0.85rem;
        display: grid;
        gap: 0.4rem;
        font-size: 0.92rem;
      }

      #topList {
        max-height: 160px;
        overflow: auto;
        overscroll-behavior: contain;
        scrollbar-gutter: stable;
      }

	      .list .row {
	        display: flex;
	        justify-content: space-between;
	        gap: 1rem;
	        padding: 0.55rem 0.75rem;
	        border: 1px solid var(--border);
	        border-radius: 0.85rem;
	        background: rgba(248, 250, 252, 0.92);
	      }

      .btns {
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

	      .btn {
	        display: inline-flex;
	        align-items: center;
	        justify-content: center;
	        padding: 0.65rem 0.95rem;
	        border-radius: 1rem;
	        border: 1px solid var(--border);
	        background: rgba(255, 255, 255, 0.92);
	        color: rgba(17, 24, 39, 0.92);
	        font-weight: 700;
	        letter-spacing: 0.01em;
	        text-transform: none;
	        font-size: 0.78rem;
	        transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
	      }

	      .btn:hover {
	        transform: translateY(-1px);
	        background: rgba(17, 24, 39, 0.03);
	        border-color: var(--border-strong);
	      }

	      .btn.green {
	        background: rgba(17, 24, 39, 0.94);
	        color: rgba(255, 255, 255, 0.96);
	        border-color: rgba(17, 24, 39, 0.30);
	      }

	      .btn.green:hover {
	        background: rgba(17, 24, 39, 0.88);
	        border-color: rgba(17, 24, 39, 0.38);
	      }

	      .footnote {
	        margin-top: 0.8rem;
	        font-size: 0.78rem;
	        color: rgba(15, 23, 42, 0.54);
	      }
    </style>
  </head>
  <body>
    <div class="bg-pattern"></div>
    <div class="glow-orb glow-orb-1"></div>
    <div class="glow-orb glow-orb-2"></div>

    <div class="command-deck processing" id="deck">
      <div class="logo">MEBOCOST mCCC Explorer</div>
      <div class="command-input-box" id="cmd">
        <span id="cmdText"></span><span class="cursor-blink"></span>
      </div>
      <div class="status-indicator">
        <div class="status-dot busy" id="dot"></div>
        <div id="status">loading</div>
      </div>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="landing-strip-overlay" id="overlay">
      <div class="stage" id="stage">
	      <div class="evidence-card card-1" id="card1">
	        <div class="agent-header">
	          <div class="agent-name">
	            <span>Agent 1 · Data Loader</span>
	          </div>
	          <span class="agent-pill" id="pill1">WAITING</span>
	        </div>
	        <div class="agent-progress"><div class="agent-progress-bar" id="ap1"></div></div>
	        <div class="muted">Loads and parses the real MEBOCOST TSV output and computes baseline dataset stats.</div>
	        <div class="card-body">
	          <div class="kv" id="kv"></div>
	          <div class="footnote" id="kvNote"></div>
	          <div class="agent-mono" id="agent1"></div>
	        </div>
	      </div>

	      <div class="evidence-card card-2" id="card2">
	        <div class="agent-header">
	          <div class="agent-name">
	            <span>Agent 2 · QC / Filter</span>
	          </div>
	          <span class="agent-pill" id="pill2">WAITING</span>
	        </div>
	        <div class="agent-progress"><div class="agent-progress-bar" id="ap2"></div></div>
	        <div class="muted">Checks `Flux_PASS` and `permutation_test_fdr`, then proposes safe defaults for the demo.</div>
	        <div class="card-body">
	          <div class="agent-mono" id="agent2"></div>
	        </div>
	      </div>

	      <div class="evidence-card card-3" id="card3">
	        <div class="agent-header">
	          <div class="agent-name">
	            <span>Agent 3 · Analyst</span>
	          </div>
	          <span class="agent-pill" id="pill3">WAITING</span>
	        </div>
	        <div class="agent-progress"><div class="agent-progress-bar" id="ap3"></div></div>
	        <div class="muted">Aggregates by `-log10(permutation_test_fdr)` (treats FDR=0 as an extremely small value) to surface high-weight signals.</div>
	        <div class="card-body">
	          <div class="list" id="topList"></div>
	          <div class="agent-mono" id="agent3"></div>
	        </div>
	        <div class="footnote">Tip: in the Explorer you can switch weight mode (FDR / Commu_Score / Norm_Commu_Score).</div>
	      </div>

	      <div class="evidence-card card-4" id="card4">
	        <div class="agent-header">
	          <div class="agent-name">
	            <span>Agent 4 · Navigator</span>
	          </div>
	          <span class="agent-pill" id="pill4">WAITING</span>
	        </div>
	        <div class="agent-progress"><div class="agent-progress-bar" id="ap4"></div></div>
	        <div class="muted">Builds reproducible URLs so the exact view can be shared and replayed.</div>
	        <div class="btns">
	          <a class="btn green" id="openExplorer" href="/">Open (Network)</a>
	          <a class="btn" id="openDotplot" href="/">Open (DotPlot)</a>
	          <a class="btn" id="openCompare" href="/">Open (Compare)</a>
	        </div>
	        <div class="card-body">
	          <div class="agent-mono" id="agent4"></div>
	        </div>
	        <div class="footnote">
	          Requires a local dev server: run <span style="font-weight: 800">pnpm dev</span> in the project, then open
	          <span style="font-weight: 800">/demos/mccc_cascade_landing.html</span>.
	        </div>
	      </div>
      </div>
    </div>

    <script>
      const DATASET = "/sample/communication_result.tsv";

      const $ = (id) => document.getElementById(id);

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      async function typewriter(el, text, { cps = 26 } = {}) {
        el.textContent = "";
        const start = performance.now();
        return new Promise((resolve) => {
          const tick = (now) => {
            const elapsed = Math.max(0, now - start);
            const n = Math.min(text.length, Math.floor((elapsed / 1000) * cps));
            el.textContent = text.slice(0, n);
            if (n >= text.length) resolve();
            else requestAnimationFrame(tick);
          };
          requestAnimationFrame(tick);
        });
      }

      function setProgress(pct) {
        const p = Math.max(0, Math.min(100, pct));
        $("progressBar").style.width = `${p}%`;
      }

      function setPill(n, state) {
        const pill = $(`pill${n}`);
        if (!pill) return;
        pill.classList.remove("run", "done");
        if (state === "RUNNING") pill.classList.add("run");
        if (state === "DONE") pill.classList.add("done");
        pill.textContent = state;
      }

      function hideAllCards() {
        const cards = [1, 2, 3, 4].map((x) => $(`card${x}`)).filter(Boolean);
        for (const c of cards) c.classList.remove("show");
      }

      function showCard(n) {
        const next = $(`card${n}`);
        if (!next) return;
        next.classList.add("show");
      }

	      function setAgentState(n, state) {
	        setPill(n, state);
	        const bar = $(`ap${n}`);
	        if (!bar) return;
	        bar.classList.remove("run", "done");
	        if (state === "RUNNING") bar.classList.add("run");
	        if (state === "DONE") bar.classList.add("done");
	        // NOTE: WAITING sets an inline width; clear/overwrite it for RUNNING/DONE so CSS/animation can show.
	        if (state === "WAITING") bar.style.width = "0%";
	        else if (state === "RUNNING") bar.style.width = "72%";
	        else if (state === "DONE") bar.style.width = "100%";
	        else bar.style.width = "";
	      }

      function toNum(v) {
        if (v === null || v === undefined) return undefined;
        const n = Number(String(v).trim());
        return Number.isFinite(n) ? n : undefined;
      }

      function quantile(sorted, q) {
        if (!sorted.length) return undefined;
        const pos = (sorted.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        if (sorted[base + 1] === undefined) return sorted[base];
        return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
      }

      function parseTsv(text) {
        const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter((l) => l.trim().length);
        if (lines.length < 2) return [];
        const headers = lines[0].split("\t");
        const rows = [];
        for (let i = 1; i < lines.length; i += 1) {
          const cols = lines[i].split("\t");
          const row = {};
          for (let j = 0; j < headers.length; j += 1) row[headers[j]] = cols[j] ?? "";
          rows.push(row);
        }
        return rows;
      }

      function aggTop(rows, key, weightKey) {
        const map = new Map();
        for (const r of rows) {
          const k = (r[key] ?? "").trim();
          if (!k) continue;
          const w = r[weightKey] ?? 1;
          const prev = map.get(k) ?? { k, w: 0, n: 0 };
          prev.w += w;
          prev.n += 1;
          map.set(k, prev);
        }
        return [...map.values()].sort((a, b) => b.w - a.w).slice(0, 6);
      }

      function renderKv(items) {
        $("kv").innerHTML = items
          .map(
            ({ k, v }) => `
            <div class="item">
              <div class="k">${k}</div>
              <div class="v">${v}</div>
            </div>`,
          )
          .join("");
      }

      function renderTop(name, items, fmt) {
        return `
          <div class="row">
            <div style="font-weight:800">${name}</div>
            <div class="muted">${items.map((x) => fmt(x)).join(" · ")}</div>
          </div>
        `;
      }

      async function main() {
        const prompt =
          `Load ${DATASET}  →  map Sender/Receiver/Metabolite_Name/Sensor  →  filter Flux_PASS=PASS & permutation_test_fdr≤0.05  →  summarize  →  open Explorer`;

        $("progress").classList.add("active");
        setProgress(4);
        $("status").textContent = "typing";
        setAgentState(1, "WAITING");
        setAgentState(2, "WAITING");
        setAgentState(3, "WAITING");
        setAgentState(4, "WAITING");
        hideAllCards();
        await typewriter($("cmdText"), prompt, { cps: 18 });
        await sleep(450);

        $("overlay").classList.add("active");
        showCard(1);
        setAgentState(1, "RUNNING");
        $("status").textContent = "fetching";
        setProgress(18);

        $("openExplorer").href = `/?sample=communication_result.tsv&view=network&flux=pass&fdr=0.05&top=300&self=0`;
        $("openDotplot").href = `/?sample=communication_result.tsv&view=dotplot&flux=pass&fdr=0.05&top=300&self=0`;
        $("openCompare").href = `/?view=compare&sampleA=communication_result.tsv&sampleB=mebocost_example.csv&flux=pass&fdr=0.05&top=300&self=0`;

        try {
          await sleep(500);
          const res = await fetch(DATASET);
          if (!res.ok) throw new Error("Fetch failed");
          const text = await res.text();
          setProgress(34);
          $("status").textContent = "parsing";
          await sleep(450);
          const rows = parseTsv(text);

          const senders = new Set();
          const receivers = new Set();
          const metabolites = new Set();
          const sensors = new Set();
          let pass = 0;
          let fluxKnown = 0;
          let zeroFdr = 0;
          let numericFdr = 0;
          let sigFdr = 0;
          let passAndSig = 0;

          const fdrs = [];
          const pairAgg = new Map();

          for (const r of rows) {
            const s = (r.Sender ?? "").trim();
            const t = (r.Receiver ?? "").trim();
            if (s) senders.add(s);
            if (t) receivers.add(t);

            const m = (r.Metabolite_Name || r.Metabolite || "").trim();
            const se = (r.Sensor || "").trim();
            if (m) metabolites.add(m);
            if (se) sensors.add(se);

            const fp = (r.Flux_PASS ?? "").trim().toUpperCase();
            if (fp) {
              fluxKnown += 1;
              if (fp === "PASS") pass += 1;
            }

            let fdr = toNum(r.permutation_test_fdr);
            if (typeof fdr === "number") {
              numericFdr += 1;
              if (fdr === 0) fdr = 1e-300;
              if (toNum(r.permutation_test_fdr) === 0) zeroFdr += 1;
              if (fdr > 0 && fdr <= 1) fdrs.push(fdr);
              if (fdr <= 0.05) sigFdr += 1;
            }

            const w = typeof fdr === "number" && fdr > 0 ? Math.min(50, -Math.log10(fdr)) : 1;
            r.__w = w;

            if (fp === "PASS" && typeof fdr === "number" && fdr > 0 && fdr <= 0.05) passAndSig += 1;

            if (s && t) {
              const key = `${s}→${t}`;
              const prev = pairAgg.get(key) ?? { key, w: 0, n: 0 };
              prev.w += w;
              prev.n += 1;
              pairAgg.set(key, prev);
            }
          }

          fdrs.sort((a, b) => a - b);
          const p50 = quantile(fdrs, 0.5);
          const p05 = quantile(fdrs, 0.05);
          const p95 = quantile(fdrs, 0.95);

          const topPair = [...pairAgg.values()].sort((a, b) => b.w - a.w)[0];

          renderKv([
            { k: "rows", v: String(rows.length) },
            { k: "senders", v: String(senders.size) },
            { k: "receivers", v: String(receivers.size) },
            { k: "metabolites", v: String(metabolites.size) },
            { k: "sensors", v: String(sensors.size) },
            { k: "Flux_PASS=PASS", v: fluxKnown ? `${pass}/${fluxKnown}` : "NA" },
          ]);

          $("kvNote").textContent =
            typeof p50 === "number"
              ? `permutation_test_fdr: p05=${p05.toExponential(2)}, median=${p50.toExponential(2)}, p95=${p95.toExponential(2)}`
              : "permutation_test_fdr: NA";

          setProgress(52);
          $("status").textContent = "agents";

          const topSenders = aggTop(rows, "Sender", "__w");
          const topReceivers = aggTop(rows, "Receiver", "__w");
          const topMetabs = aggTop(rows, "Metabolite_Name", "__w");

          const top = [];
          top.push(
            renderTop(
              "Top Sender",
              topSenders.slice(0, 4),
              (x) => `${x.k} (${Math.round(x.w)})`,
            ),
          );
          top.push(
            renderTop(
              "Top Receiver",
              topReceivers.slice(0, 4),
              (x) => `${x.k} (${Math.round(x.w)})`,
            ),
          );
          top.push(
            renderTop(
              "Top Metabolite",
              topMetabs.slice(0, 4),
              (x) => `${x.k} (${Math.round(x.w)})`,
            ),
          );
          if (topPair) top.push(renderTop("Top Pair", [topPair], (x) => `${x.key} (${Math.round(x.w)} / ${x.n} hits)`));
          $("topList").innerHTML = top.join("");

          // Agent 1
          await typewriter(
            $("agent1"),
            [
              `✓ Parsed TSV rows: ${rows.length}`,
              `✓ Unique sender→receiver pairs: ${pairAgg.size}`,
              `✓ Fields detected: Sender / Receiver / Metabolite_Name / Sensor / permutation_test_fdr / Flux_PASS`,
            ].join("\n"),
            { cps: 24 },
          );
          setAgentState(1, "DONE");
          setProgress(64);
          await sleep(650);

          // Agent 2
          showCard(2);
          setAgentState(2, "RUNNING");
          await sleep(260);
          const qcLines = [];
          qcLines.push(`Flux_PASS present: ${fluxKnown}/${rows.length}`);
          qcLines.push(`Flux_PASS=PASS: ${pass}/${fluxKnown || rows.length}`);
          qcLines.push(`permutation_test_fdr numeric: ${numericFdr}/${rows.length}`);
          qcLines.push(`permutation_test_fdr=0: ${zeroFdr}`);
          qcLines.push(`permutation_test_fdr≤0.05: ${sigFdr}`);
          qcLines.push(`PASS & (FDR≤0.05): ${passAndSig}`);
          qcLines.push("");
          qcLines.push("Recommended demo filters:");
          qcLines.push("- Flux_PASS = PASS");
          qcLines.push("- permutation_test_fdr ≤ 0.05");
          qcLines.push("- top edges ≤ 300");
          await typewriter($("agent2"), qcLines.join("\n"), { cps: 24 });
          setAgentState(2, "DONE");
          setProgress(78);
          await sleep(650);

          // Agent 3
          showCard(3);
          setAgentState(3, "RUNNING");
          await sleep(260);
          const explain = [];
          if (topPair) explain.push(`Top pair (by aggregated -log10(FDR)): ${topPair.key}  [hits=${topPair.n}]`);
          explain.push(`Top sender examples: ${topSenders.slice(0, 3).map((x) => x.k).join(", ") || "NA"}`);
          explain.push(`Top receiver examples: ${topReceivers.slice(0, 3).map((x) => x.k).join(", ") || "NA"}`);
          explain.push(`Top metabolite examples: ${topMetabs.slice(0, 3).map((x) => x.k).join(", ") || "NA"}`);
          explain.push("");
          explain.push("Next step: open Explorer and click a cell type / pair to drill down (partners, metabolites, sensors).");
          await typewriter($("agent3"), explain.join("\n"), { cps: 22 });
          setAgentState(3, "DONE");
          setProgress(90);
          await sleep(650);

          // Agent 4 (show after analysis)
          showCard(4);
          setAgentState(4, "RUNNING");
          await sleep(650);
	          await typewriter(
	            $("agent4"),
	            [
	              "Links are reproducible:",
	              `- Network: ${$("openExplorer").getAttribute("href")}`,
	              `- DotPlot: ${$("openDotplot").getAttribute("href")}`,
	              "",
	              "Tip: use the Share URL button in the app to copy the full URL.",
	            ].join("\n"),
	            { cps: 22 },
	          );
          setAgentState(4, "DONE");
          setProgress(100);

          $("deck").classList.remove("processing");
          $("dot").classList.remove("busy");
          $("status").textContent = "ready";

          await sleep(250);
          $("progress").classList.remove("active");
        } catch (e) {
          $("status").textContent = "error";
          $("cmdText").textContent = `Failed to load: ${DATASET}`;
          $("deck").classList.remove("processing");
          $("dot").classList.remove("busy");
          $("progress").classList.remove("active");
          $("kv").innerHTML = `<div class="muted">Unable to load the dataset. Open this page via the dev server (not via file://).</div>`;
        }
      }

      main();
    </script>
  </body>
</html>
